(()=>{"use strict";var e=function(e,t,a,i){return new(a||(a=Promise))((function(s,n){function g(e){try{o(i.next(e))}catch(e){n(e)}}function l(e){try{o(i.throw(e))}catch(e){n(e)}}function o(e){var t;e.done?s(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(g,l)}o((i=i.apply(e,t||[])).next())}))};figma.showUI(__html__,{height:600,width:400,title:"StoryNode"});let t=!1,a=!1,i=null;figma.on("selectionchange",(()=>e(void 0,void 0,void 0,(function*(){t?(()=>{var e;const t=figma.currentPage.selection;if(!t.length)return void figma.notify("请选择文字节点!");const a=t[0];let i=null!=a.characters?a.characters:null!=(null===(e=a.text)||void 0===e?void 0:e.characters)?a.text.characters:null;i?figma.ui.postMessage({type:"selectionchange",data:{id:a.id,type:a.type,content:i}}):figma.notify("请选择文字节点!")})():a&&(yield e(void 0,void 0,void 0,(function*(){var e;const t=figma.currentPage.selection;if(!t.length)return void figma.notify("请选择文字节点!");const s=t[0];null!=s.characters?(yield figma.loadFontAsync(s.fontName),s.characters=i||s.name):null!=(null===(e=s.text)||void 0===e?void 0:e.characters)&&(yield figma.loadFontAsync(s.text.fontName),s.text.characters=i||s.name),figma.ui.postMessage({type:"clearReplace"}),a=!1,i=null})))})))),figma.ui.onmessage=s=>e(void 0,void 0,void 0,(function*(){if("message"===s.type&&figma.notify(s.data),"saveTextKey"===s.type&&(yield figma.clientStorage.setAsync("textKey",s.data),figma.ui.postMessage({type:"saveTextKeyComplete",data:""})),"readTextKey"===s.type&&figma.clientStorage.getAsync("textKey").then((e=>{figma.ui.postMessage({type:"readTextKey",data:e||null})})),"saveImageKey"===s.type&&(yield figma.clientStorage.setAsync("imageKey",s.data),figma.ui.postMessage({type:"saveImageKeyComplete",data:""})),"readImageKey"===s.type&&figma.clientStorage.getAsync("imageKey").then((e=>{figma.ui.postMessage({type:"readImageKey",data:e||null})})),"saveMusicKey"===s.type&&(yield figma.clientStorage.setAsync("musicKey",s.data),figma.ui.postMessage({type:"saveMusicKeyComplete",data:""})),"readMusicKey"===s.type&&figma.clientStorage.getAsync("musicKey").then((e=>{figma.ui.postMessage({type:"readMusicKey",data:e||null})})),"saveOptimize"===s.type&&(yield figma.clientStorage.setAsync("optimizeList",JSON.stringify(s.data)),figma.ui.postMessage({type:"saveOptimizeComplete",data:""})),"readOptimize"===s.type&&figma.clientStorage.getAsync("optimizeList").then((e=>{figma.ui.postMessage({type:"readOptimize",data:e?JSON.parse(e):null})})),"deleteOptimize"===s.type&&(yield figma.clientStorage.deleteAsync("optimizeList")),"addRoles"===s.type){const t=s.data;figma.clientStorage.getAsync("roles").then((a=>e(void 0,void 0,void 0,(function*(){let e=JSON.parse(a);if(t.id){const a=[];for(let i=0;i<e.length;i++){const s=e[i];s.id===t.id?a.push(t):a.push(s)}e=a}else t.id=String((new Date).getTime()),e.push(t);yield figma.clientStorage.setAsync("roles",JSON.stringify(e)),figma.ui.postMessage({type:"addRolesComplete",data:""})}))))}if("saveRoles"===s.type&&(yield figma.clientStorage.setAsync("roles",JSON.stringify(s.data))),"readRoles"===s.type&&figma.clientStorage.getAsync("roles").then((e=>{figma.ui.postMessage({type:"readRoles",data:e?JSON.parse(e):null})})),"deleteRoles"===s.type&&(yield figma.clientStorage.deleteAsync("roles")),"saveModel"===s.type&&(yield figma.clientStorage.setAsync("currentModel",s.data)),"readModel"===s.type&&figma.clientStorage.getAsync("currentModel").then((e=>{e&&figma.ui.postMessage({type:"readModel",data:parseInt(e)})})),"deleteAllMessage"===s.type&&(yield figma.clientStorage.deleteAsync("saveMessage")),"deleteMessage"===s.type&&figma.clientStorage.getAsync("saveMessage").then((t=>e(void 0,void 0,void 0,(function*(){if(t){const e=s.id,a=JSON.parse(t),i=[];for(let t=0;t<a.length;t++){const s=a[t];s.id!==e&&i.push(s)}yield figma.clientStorage.setAsync("saveMessage",JSON.stringify(i))}})))),"saveMessage"===s.type){const t={id:s.id,messages:s.data};figma.clientStorage.getAsync("saveMessage").then((a=>e(void 0,void 0,void 0,(function*(){if(a){let e=JSON.parse(a);const i=[];let s=!1;for(let a=0;a<e.length;a++){const n=e[a];n.id===t.id?(i.push(t),s=!0):i.push(n)}s||i.push(t),e=i,yield figma.clientStorage.setAsync("saveMessage",JSON.stringify(e))}else yield figma.clientStorage.setAsync("saveMessage",JSON.stringify([t]))}))))}if("readMessage"===s.type&&figma.clientStorage.getAsync("saveMessage").then((e=>{if(e){const t=s.id,a=JSON.parse(e);let i=null;for(let e=0;e<a.length;e++){const s=a[e];if(s.id===t){i=s.messages;break}}figma.ui.postMessage({type:"readMessage",data:i||null})}else figma.ui.postMessage({type:"readMessage",data:null})})),"switchExport"===s.type&&(t=!0,a=!1,i=null),"switchReplace"===s.type&&(a=!0,i=s.data?s.data:null,t=!1),"switchReplaceUpdate"===s.type&&(i=s.data),"clearMode"===s.type&&(t=!1,a=!1,i=null),"createWidget"===s.type){t=!1,a=!1,i=null;let n=null,g=null,l=[];if("SQUARE"===s.widget||"ELLIPSE"===s.widget||"ROUNDED_RECTANGLE"===s.widget||"DIAMOND"===s.widget||"TRIANGLE_UP"===s.widget||"TRIANGLE_DOWN"===s.widget||"PARALLELOGRAM_RIGHT"===s.widget||"PARALLELOGRAM_LEFT"===s.widget||"ENG_DATABASE"===s.widget||"ENG_QUEUE"===s.widget||"ENG_FILE"===s.widget||"ENG_FOLDER"===s.widget)for(let e of s.data){const t=figma.createShapeWithText();if(t.shapeType=s.widget,null==n){const{x:e,y:a}=figma.viewport.center;n=e-(10*(s.data.length-1)+t.width*s.data.length)/2,g=a-t.height/2}t.x=n,t.y=g,n+=t.width+10,yield figma.loadFontAsync(t.text.fontName),t.text.characters=e,l.push(t)}else if("TEXT"===s.widget)for(let e of s.data){const t=figma.createText();if(null==g){const{x:e,y:a}=figma.viewport.center;n=e-t.width/2,g=a}t.x=n,t.y=g,g+=t.height+10,yield figma.loadFontAsync(t.fontName),t.characters=e,l.push(t)}else if("IMAGE"===s.widget)figma.notify("Downloading images, please wait..."),figma.createImageAsync(s.data).then((t=>e(void 0,void 0,void 0,(function*(){const e=figma.createRectangle(),{width:a,height:i}=yield t.getSizeAsync();e.resize(a,i);const{x:s,y:n}=figma.viewport.center;e.x=s-e.width/2,e.y=n-e.height/2,e.fills=[{type:"IMAGE",imageHash:t.hash,scaleMode:"FILL"}],figma.notify("Image added completed!")})))).catch((e=>{throw console.log(e),e}));else for(let e of s.data){const t=figma.createSticky();if(null==n){const{x:e,y:a}=figma.viewport.center;n=e-(10*(s.data.length-1)+t.width*s.data.length)/2,g=a-t.height/2}t.x=n,t.y=g,n+=t.width+10,yield figma.loadFontAsync(t.text.fontName),t.text.characters=e,l.push(t)}figma.currentPage.selection=l}}))})();